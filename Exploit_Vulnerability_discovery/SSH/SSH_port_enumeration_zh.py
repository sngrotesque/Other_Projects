import socket
from sys import argv,exit,platform
from os import system as sy
from colorama import Fore,Style
import re

if len(argv)<2:
    print(Fore.LIGHTBLUE_EX+"[-]使用方法: python3 %s [IP] [Port range]"%argv[0])
    print("[-]如: python %s 127.0.0.1 22-34"%argv[0])
    print("[-]如果不指定端口范围，脚本将会从0号端口开始一直到65535端口结束\n\
    \r[-]范围符号可以使用除数字和空格以外的任何符号，如(22,34),(22=34),(22p34)等")
    exit(Fore.LIGHTRED_EX+"[*]警告此脚本将清除终端输出的其他内容。（命令：clear）\n\
    \r[*]连接超时的时间默认为[0.2]秒，可自行修改。"+Style.RESET_ALL)

host=argv[1]
sdata=b"SSH-2.0-OpenSSH_8.4p1 Debian-5"

try:
    portrange=re.findall(r"\d+",argv[2],re.S)
    for x in range(len(portrange)):
        portrange[x]=int(portrange[x])

    min_port=portrange[0]
    max_port=portrange[1]

    while min_port <= max_port:
        if platform=="linux":
            sy("clear")
        elif platform=="win32":
            sy("cls")
        print("[-]正在测试[%d]端口..."%min_port)
        s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.settimeout(0.2)
        res=b""
        try:
            s.connect((host,min_port))
            s.sendall(sdata)
            res=s.recv(512)
            try:
                res=re.findall(b"(SSH.*)",res,re.S)[0]
                exit(Fore.LIGHTCYAN_EX+"[+][%d]端口是SSH协议，内容为%s"%(min_port,str(res,encoding="utf8",errors="ignore")))
            except IndexError:
                continue
        except socket.timeout:
            print("[%d]端口连接超时"%min_port)
        except ConnectionRefusedError:
            print("连接被重设...")
        min_port+=1
except IndexError:
    for x in range(65536):
        if platform=="linux":
            sy("clear")
        elif platform=="win32":
            sy("cls")
        print("[-]正在测试[%d]端口..."%x)
        s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.settimeout(0.2)
        res=b""
        try:
            s.connect((host,x))
            s.sendall(sdata)
            res=s.recv(512)
            try:
                res=re.findall(b"(SSH.*)",res,re.S)[0]
                exit(Fore.LIGHTCYAN_EX+"[+][%d]端口是SSH协议，内容为%s"%(x,str(res,encoding="utf8",errors="ignore")))
            except IndexError:
                continue
        except socket.timeout:
            print("[%d]端口连接超时"%x)
        except ConnectionRefusedError:
            print("连接被重设...")
        s.close()
